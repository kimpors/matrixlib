name: Deploy to Nuget

on:
  push:
    tags:
      - 'v*'

env:
  PROJECT_PATH: 'MatrixLib/MatrixLib.csproj'

jobs:
  deploy:
    name: 'Deploy'
    runs-on: 'ubuntu-latest'

    steps:
    - name: 'Checkout'
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Install .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x

    - name: 'Test Project'
      run: dotnet test
      
    - name: 'Build Project'
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release

    - name: 'Authenticate to Nuget'
      run: dotnet nuget add source --username kimpors --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/kimpors/index.json"

    - name: 'Get Version'
      uses: actions/checkout@v2
    - run: echo "VERSION=${GITHUB_REF#refs/*/v}" >> $GITHUB_ENV
    - run: echo ${{ env.VERSION }}

    - name: 'Pack Project'
      run: dotnet pack matrixlib.sln --no-restore --no-build --configuration Release -p:PackageVersion-${{ env.VERSION }}
      
    - name: 'Push Package'
      run: dotnet nuget push "MatrixLib/bin/Release/*.nupkg" --api-key NUGET_KEY --source "github"
